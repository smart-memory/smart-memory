#!/bin/bash
set -e

# Absolute path to project root
PROJECT_ROOT="$(cd "$(dirname "$0")" && pwd)"
SMARTMEMORY_DOCS_DIR="$PROJECT_ROOT/docs/public"
SMARTMEMORY_BUILD_DIR="$SMARTMEMORY_DOCS_DIR/build"
MAYA_DOCS_DIR="$PROJECT_ROOT/../maya/docs/public"
MAYA_BUILD_DIR="$MAYA_DOCS_DIR/build"
ROOT_INDEX="$PROJECT_ROOT/index.html"
REACT_SITE_DIR="$PROJECT_ROOT/docs/root-page"
REACT_BUILD_DIR="$REACT_SITE_DIR/dist"
ARCH_DOCS_DIR="$PROJECT_ROOT/docs"
DEPLOY_DIR="$PROJECT_ROOT/deploy"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Logging functions
log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# Function to check if command exists
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

# Function to check prerequisites
check_prerequisites() {
    log_info "Checking prerequisites for Maya docs deployment..."

    # Check for required commands
    local missing_commands=()

    if ! command_exists npm; then
        missing_commands+=("npm")
    fi

    if ! command_exists python3; then
        missing_commands+=("python3")
    fi

    if ! command_exists aws; then
        missing_commands+=("aws")
    fi

    if [ ${#missing_commands[@]} -ne 0 ]; then
        log_error "Missing required commands: ${missing_commands[*]}"
        log_error "Please install the missing commands and try again."
        exit 1
    fi

    # Check AWS credentials
    if ! aws sts get-caller-identity --profile reg >/dev/null 2>&1; then
        log_error "AWS credentials not configured for 'reg' profile"
        log_error "Please configure AWS credentials: aws configure --profile reg"
        exit 1
    fi

    log_success "Prerequisites check passed for Maya docs at https://docs.smartmemory.ai/maya"
}

# Function to build React site
build_react_site() {
    log_info "Building React site for Maya docs at https://docs.smartmemory.ai/maya..."

    if [ ! -d "$REACT_SITE_DIR" ]; then
        log_error "React site directory not found: $REACT_SITE_DIR"
        return 1
    fi

    cd "$REACT_SITE_DIR"

    # Install dependencies if needed
    if [ ! -d "node_modules" ]; then
        log_info "Installing React site dependencies for Maya docs..."
        npm install
    fi

    # Build the React site
    log_info "Building React site for Maya docs..."
    npm run build

    if [ ! -d "$REACT_BUILD_DIR" ]; then
        log_error "React build output not found"
        return 1
    fi

    log_success "React site built successfully for Maya docs at https://docs.smartmemory.ai/maya"
    return 0
}

# Function to build Maya documentation
build_maya_docs() {
    log_info "Building Maya documentation at https://docs.smartmemory.ai/maya..."

    if [ ! -d "$MAYA_DOCS_DIR" ]; then
        log_error "Maya docs directory not found: $MAYA_DOCS_DIR"
        return 1
    fi

    cd "$MAYA_DOCS_DIR"

    # Install dependencies if needed
    if [ ! -d "node_modules" ]; then
        log_info "Installing Maya docs dependencies for https://docs.smartmemory.ai/maya..."
        npm install
    fi

    # Build the documentation
    log_info "Building Maya docs for https://docs.smartmemory.ai/maya..."
    npm run build

    if [ ! -d "$MAYA_BUILD_DIR" ]; then
        log_error "Maya build output not found"
        return 1
    fi

    log_success "Maya docs built successfully at https://docs.smartmemory.ai/maya"
    return 0
}

# Function to build SmartMemory documentation
build_smartmemory_docs() {
    log_info "Building SmartMemory Core documentation for Maya docs at https://docs.smartmemory.ai/maya..."

    if [ ! -d "$SMARTMEMORY_DOCS_DIR" ]; then
        log_error "SmartMemory docs directory not found: $SMARTMEMORY_DOCS_DIR"
        return 1
    fi

    cd "$SMARTMEMORY_DOCS_DIR"

    # Install dependencies if needed
    if [ ! -d "node_modules" ]; then
        log_info "Installing SmartMemory docs dependencies for Maya docs..."
        npm install
    fi

    # Build the documentation
    log_info "Building SmartMemory docs for Maya at https://docs.smartmemory.ai/maya..."
    npm run build

    if [ ! -d "$SMARTMEMORY_BUILD_DIR" ]; then
        log_error "SmartMemory build output not found"
        return 1
    fi

    log_success "SmartMemory docs built successfully for Maya at https://docs.smartmemory.ai/maya"
    return 0
}


# Function to prepare deployment directory
prepare_deployment() {
    log_info "Preparing deployment directory for Maya docs at https://docs.smartmemory.ai/maya..."

    # Create deployment directory structure
    mkdir -p "$DEPLOY_DIR"
    rm -rf "$DEPLOY_DIR"/*

    # Copy Maya docs
    if [ -d "$MAYA_BUILD_DIR" ]; then
        cp -r "$MAYA_BUILD_DIR" "$DEPLOY_DIR/maya"
        log_success "Maya docs copied to deployment directory for https://docs.smartmemory.ai/maya"
    else
        log_error "Maya build directory not found"
        return 1
    fi

    # Copy SmartMemory docs
    if [ -d "$SMARTMEMORY_BUILD_DIR" ]; then
        cp -r "$SMARTMEMORY_BUILD_DIR" "$DEPLOY_DIR/smart-memory"
        log_success "SmartMemory docs copied to deployment directory for Maya at https://docs.smartmemory.ai/maya"
    else
        log_error "SmartMemory build directory not found"
        return 1
    fi

    # Copy React site build (replaces root index.html)
    if [ -d "$REACT_BUILD_DIR" ]; then
        log_info "Copying React site build to deployment directory for Maya docs..."
        cp -r "$REACT_BUILD_DIR"/* "$DEPLOY_DIR/"
        log_success "React site copied to deployment directory for Maya at https://docs.smartmemory.ai/maya"
    else
        log_warning "React build not found, falling back to static index.html"
        if [ -f "$ROOT_INDEX" ]; then
            cp "$ROOT_INDEX" "$DEPLOY_DIR/index.html"
            log_success "Root index.html copied to deployment directory for Maya at https://docs.smartmemory.ai/maya"
        else
            log_error "Neither React build nor root index.html found"
            return 1
        fi
    fi

    # Copy root-page assets (LogoOnly.png and favicon.ico)
    log_info "Copying root-page assets to deployment directory..."
    if [ -f "$PROJECT_ROOT/docs/root-page/LogoOnly.png" ]; then
        cp "$PROJECT_ROOT/docs/root-page/LogoOnly.png" "$DEPLOY_DIR/"
        log_success "LogoOnly.png copied to deployment directory"
    else
        log_warning "LogoOnly.png not found in docs/root-page/"
    fi
    
    if [ -f "$PROJECT_ROOT/docs/root-page/favicon.ico" ]; then
        cp "$PROJECT_ROOT/docs/root-page/favicon.ico" "$DEPLOY_DIR/"
        log_success "favicon.ico copied to deployment directory"
    else
        log_warning "favicon.ico not found in docs/root-page/"
    fi

    log_success "Deployment directory prepared for Maya docs at https://docs.smartmemory.ai/maya"
}

# Function to sync to S3
sync_to_s3() {
    log_info "Syncing Maya documentation to S3 at https://docs.smartmemory.ai/maya..."

    # Sync Maya docs to S3 with cache control
    log_info "Syncing Maya docs to s3://docs.smartmemory.ai/maya (visit https://docs.smartmemory.ai/maya)..."
    aws s3 sync "$DEPLOY_DIR/maya" s3://docs.smartmemory.ai/maya --delete --profile reg \
        --cache-control "public, max-age=3600" --metadata-directive REPLACE
    
    # Set longer cache for static assets
    log_info "Setting long cache for Maya static assets at https://docs.smartmemory.ai/maya..."
    aws s3 sync "$DEPLOY_DIR/maya" s3://docs.smartmemory.ai/maya \
        --exclude "*" \
        --include "*.css" \
        --include "*.js" \
        --include "*.png" \
        --include "*.jpg" \
        --include "*.jpeg" \
        --include "*.gif" \
        --include "*.svg" \
        --include "*.ico" \
        --cache-control "public, max-age=31536000" \
        --metadata-directive REPLACE \
        --profile reg

    # Sync SmartMemory docs to S3
    log_info "Syncing SmartMemory docs to s3://docs.smartmemory.ai/smart-memory for Maya at https://docs.smartmemory.ai/maya..."
    aws s3 sync "$DEPLOY_DIR/smart-memory" s3://docs.smartmemory.ai/smart-memory --delete --profile reg

    # Sync architecture docs to S3
    if [ -d "$DEPLOY_DIR/architecture" ]; then
        log_info "Syncing architecture docs to s3://docs.smartmemory.ai/architecture for Maya at https://docs.smartmemory.ai/maya..."
        aws s3 sync "$DEPLOY_DIR/architecture" s3://docs.smartmemory.ai/architecture --delete --profile reg
    fi

    # Upload React site files (or fallback index.html)
    log_info "Uploading landing page files for Maya docs at https://docs.smartmemory.ai/maya..."
    
    # Upload main index.html
    if [ -f "$DEPLOY_DIR/index.html" ]; then
        aws s3 cp "$DEPLOY_DIR/index.html" s3://docs.smartmemory.ai/index.html --content-type text/html --profile reg
    fi
    
    # Upload React assets if they exist
    if [ -d "$DEPLOY_DIR/assets" ]; then
        log_info "Uploading React assets for Maya at https://docs.smartmemory.ai/maya..."
        aws s3 sync "$DEPLOY_DIR/assets" s3://docs.smartmemory.ai/assets --delete --profile reg
    fi

    log_success "Maya documentation synced to S3 successfully at https://docs.smartmemory.ai/maya"
}

# Function to display usage
usage() {
    echo "Usage: $0 [OPTIONS]"
    echo ""
    echo "Options:"
    echo "  --build-only     Build documentation without deploying"
    echo "  --deploy-only    Deploy existing build without rebuilding"
    echo "  --maya-only      Build and deploy only Maya documentation"
    echo "  --smartmemory-only Build and deploy only SmartMemory documentation"
    echo "  --architecture-only Build and deploy only architecture documentation"
    echo "  --help           Show this help message"
    echo ""
    echo "Examples:"
    echo "  $0                    # Build and deploy all documentation"
    echo "  $0 --build-only       # Build all documentation locally"
    echo "  $0 --maya-only        # Build and deploy only Maya docs"
}

# Main execution
main() {
    local build_only=false
    local deploy_only=false
    local maya_only=false
    local smartmemory_only=false
    local architecture_only=false

    # Parse command line arguments
    while [[ $# -gt 0 ]]; do
        case $1 in
            --build-only)
                build_only=true
                shift
                ;;
            --deploy-only)
                deploy_only=true
                shift
                ;;
            --maya-only)
                maya_only=true
                shift
                ;;
            --smartmemory-only)
                smartmemory_only=true
                shift
                ;;
            --architecture-only)
                architecture_only=true
                shift
                ;;
            --help)
                usage
                exit 0
                ;;
            *)
                log_error "Unknown option: $1"
                usage
                exit 1
                ;;
        esac
    done

    # Check prerequisites
    check_prerequisites

    log_info "üöÄ Starting Maya documentation build and deployment for https://docs.smartmemory.ai/maya..."
    echo "=================================================="

    # Build phase
    if [ "$deploy_only" = false ]; then
        local build_success=true

        # Build Maya docs
        if ! build_maya_docs; then
            build_success=false
        fi

        # Build React site (landing page)
        if ! build_react_site; then
            build_success=false
        fi

        if [ "$architecture_only" = false ]; then
            if ! build_smartmemory_docs; then
                build_success=false
            fi
        fi


        if [ "$build_success" = false ]; then
            log_error "Some builds failed. Aborting deployment."
            exit 1
        fi

        # Prepare deployment directory
        if ! prepare_deployment; then
            log_error "Failed to prepare deployment directory"
            exit 1
        fi
    fi

    # Deploy phase
    if [ "$build_only" = false ]; then
        if ! sync_to_s3; then
            log_error "Failed to sync to S3"
            exit 1
        fi

        echo ""
        echo "=================================================="
        log_success "üéâ Maya documentation deployment completed successfully!"
        echo ""
        log_info "üìñ Maya Documentation URL:"
        echo "   ‚Ä¢ Maya Docs: https://docs.smartmemory.ai/maya"
        echo ""
    else
        echo ""
        echo "=================================================="
        log_success "üéâ Maya documentation build completed successfully!"
        log_info "üìÅ Built Maya documentation available in: $DEPLOY_DIR (for https://docs.smartmemory.ai/maya)"
        echo ""
    fi
}

# Run main function with all arguments
main "$@"