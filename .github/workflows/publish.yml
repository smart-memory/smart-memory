name: Publish to PyPI

on:
  push:
    branches:
      - main
    paths:
      - 'VERSION'
  workflow_dispatch:  # Allow manual trigger

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write  # Required for trusted publishing
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build twine
    
    - name: Check if version exists on PyPI
      id: check_version
      run: |
        VERSION=$(cat VERSION | tr -d '\n')
        echo "ðŸ“¦ Local version: $VERSION"
        
        # Check if version exists on PyPI
        if pip index versions smartmemory 2>/dev/null | grep -q "($VERSION)"; then
          echo "â­ï¸  Version $VERSION already exists on PyPI, skipping..."
          echo "skip=true" >> $GITHUB_OUTPUT
        else
          echo "âœ… Version $VERSION not found on PyPI, proceeding with publish..."
          echo "skip=false" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
        fi
    
    - name: Clean previous builds
      if: steps.check_version.outputs.skip != 'true'
      run: |
        rm -rf dist/ build/ *.egg-info
    
    - name: Build package
      if: steps.check_version.outputs.skip != 'true'
      run: |
        python -m build
        echo "ðŸ“¦ Package built successfully"
        ls -lh dist/
    
    - name: Check package
      if: steps.check_version.outputs.skip != 'true'
      run: |
        twine check dist/*
        echo "âœ… Package validation passed"
    
    - name: Verify package contents
      if: steps.check_version.outputs.skip != 'true'
      run: |
        # List contents of the wheel
        python -m zipfile -l dist/*.whl | head -20
        echo "..."
        echo "âœ… Package contents verified"
    
    - name: Publish to PyPI
      if: steps.check_version.outputs.skip != 'true'
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.PYPI_API_KEY }}
      run: |
        echo "ðŸš€ Publishing to PyPI..."
        twine upload dist/* --verbose
        echo "âœ… Published to PyPI successfully!"
    
    - name: Wait for PyPI to update
      if: steps.check_version.outputs.skip != 'true'
      run: |
        echo "â³ Waiting 60 seconds for PyPI to update..."
        sleep 60
    
    - name: Test installation from PyPI
      if: steps.check_version.outputs.skip != 'true'
      run: |
        # Create fresh virtual environment
        python -m venv test-env
        source test-env/bin/activate
        
        # Install from PyPI
        pip install smartmemory --no-cache-dir
        
        # Test import
        python -c "from smartmemory import SmartMemory; print('âœ… Package installed successfully from PyPI!')"
        python -c "from smartmemory import __version__; print(f'ðŸ“¦ Version: {__version__}')"
        
        deactivate
    
    - name: Create deployment summary
      if: steps.check_version.outputs.skip != 'true'
      run: |
        VERSION=$(cat VERSION | tr -d '\n')
        echo "## ðŸŽ‰ SmartMemory v$VERSION Published to PyPI" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Installation" >> $GITHUB_STEP_SUMMARY
        echo '```bash' >> $GITHUB_STEP_SUMMARY
        echo "pip install smartmemory==$VERSION" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Links" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“¦ [PyPI Package](https://pypi.org/project/smartmemory/$VERSION/)" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“š [Documentation](https://docs.smartmemory.ai)" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ™ [GitHub Repository](https://github.com/smart-memory/smart-memory)" >> $GITHUB_STEP_SUMMARY

    - name: Notify Discord
      if: ${{ always() && secrets.DISCORD_WEBHOOK != '' }}
      uses: smart-memory/smart-memory-infra/.github/actions/discord-notify@main
      with:
        discord_webhook: ${{ secrets.DISCORD_WEBHOOK }}
        status: ${{ job.status }}
