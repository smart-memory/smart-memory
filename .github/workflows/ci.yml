name: CI

on:
  pull_request:

concurrency:
  group: "${{ github.workflow }}-${{ github.ref }}"
  cancel-in-progress: true

jobs:
  test:
    name: CI Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout smart-memory
        uses: actions/checkout@v4

      - name: Setup uv
        uses: astral-sh/setup-uv@v5

      - name: Install dependencies
        run: |
          uv venv --python 3.11
          uv pip install --python .venv/bin/python -e ".[dev]"
          .venv/bin/python -m spacy download en_core_web_sm

      - name: Run CI-tier tests
        run: |
          PYTHONPATH=. .venv/bin/python -m pytest tests/ -v -m "not (integration or e2e or golden or harness or slow or smoke)" --cov=smartmemory --cov-report=xml

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml
          flags: ci
          name: ci-tests

      - name: Notify Discord
        if: always()
        uses: smart-memory/smart-memory-infra/.github/actions/discord-notify@main
        with:
          discord_webhook: ${{ secrets.DISCORD_WEBHOOK }}
          status: ${{ job.status }}
          job_name: "CI Tests"
